<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Gerador — IA Operacional 30D</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#050816;
      --bg1:#0b1220;
      --muted:#9aa4b2;
      --text:#eef2ff;
      --line:rgba(255,255,255,.10);
      --shadow: 0 18px 55px rgba(0,0,0,.40);
      --radius: 18px;
      --accent: #7c3aed;
      --accent2:#22c55e;
      --danger:#ef4444;
      --warn:#f59e0b;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 10% -10%, rgba(124,58,237,.35), transparent 60%),
        radial-gradient(900px 600px at 95% 10%, rgba(34,197,94,.18), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
    }
    a{ color:inherit; text-decoration:none; }
    .wrap{ max-width:1140px; margin:0 auto; padding:26px 16px 54px; }
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:14px;
      padding:14px 16px; border:1px solid var(--line); border-radius:18px;
      background:rgba(255,255,255,.03); box-shadow:var(--shadow);
      position:sticky; top:14px; backdrop-filter: blur(10px);
      z-index:5;
    }
    .brand{ display:flex; gap:12px; align-items:center; }
    .logo{
      width:42px; height:42px; border-radius:14px;
      background: radial-gradient(circle at 25% 25%, rgba(124,58,237,.9), rgba(34,197,94,.25) 55%, rgba(255,255,255,.05) 75%);
      border:1px solid var(--line);
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
    }
    .btxt b{ display:block; font-size:14px; letter-spacing:.2px; }
    .btxt span{ display:block; color:var(--muted); font-size:12px; margin-top:2px; }

    .row{ display:flex; gap:10px; align-items:center; }
    .pill{
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background:rgba(255,255,255,.03);
      color:var(--muted);
      font-size:12px;
      display:inline-flex; gap:8px; align-items:center;
      white-space:nowrap;
    }
    .pill strong{ color:var(--text); font-weight:600; }
    .btn{
      appearance:none; border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px; border-radius:12px;
      cursor:pointer; font-weight:600;
      transition:.15s transform, .15s background;
      box-shadow: 0 12px 35px rgba(0,0,0,.28);
    }
    .btn:hover{ transform: translateY(-1px); background:rgba(255,255,255,.06); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; }
    .btnPrimary{ border-color: rgba(124,58,237,.55); background: rgba(124,58,237,.18); }
    .btnDanger{ border-color: rgba(239,68,68,.55); background: rgba(239,68,68,.14); }
    .btnGhost{ background:transparent; box-shadow:none; }

    .grid{
      display:grid; grid-template-columns: 1.12fr .88fr;
      gap:16px; margin-top:16px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .topbar{ position:static; }
    }

    .card{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(255,255,255,.03);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding:16px 16px 14px;
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      border-bottom:1px solid var(--line);
    }
    .cardTitle{ margin:0; font-size:15px; }
    .cardSub{ margin:6px 0 0; color:var(--muted); font-size:12px; line-height:1.35; }
    .cardBody{ padding:16px; }

    label{ display:block; font-size:12px; color:var(--muted); margin:0 0 6px; }
    .field{
      width:100%; padding:12px 12px;
      border-radius:14px; border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);
      outline:none;
    }
    textarea.field{ min-height:92px; resize:vertical; }
    .formGrid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 680px){ .formGrid{ grid-template-columns:1fr; } }
    .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }

    .badge{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      padding:8px 10px;
      font-size:12px;
      border-radius:999px;
      white-space:nowrap;
      align-self:flex-start;
    }
    .badge.ok{ border-color: rgba(34,197,94,.55); color:#bff7d6; background:rgba(34,197,94,.10); }
    .badge.err{ border-color: rgba(239,68,68,.55); color:#ffd1d1; background:rgba(239,68,68,.10); }
    .badge.loading{ border-color: rgba(245,158,11,.55); color:#ffe7bf; background:rgba(245,158,11,.08); }

    .output{
      width:100%;
      min-height: 290px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding: 12px 12px;
      line-height: 1.35;
      white-space: pre-wrap;
      resize: vertical;
      outline:none;
    }
    .miniHelp{ font-size:12px; color:var(--muted); margin-top:10px; line-height:1.35; }

    .loginBox{
      display:flex; flex-direction:column; gap:12px;
    }
    .loginRow{ display:flex; gap:10px; flex-wrap:wrap; }
    .loginRow > *{ flex:1; min-width: 220px; }
    .splitLine{ height:1px; background: var(--line); margin:6px 0; }

    .historyList{ display:flex; flex-direction:column; gap:10px; padding-top:10px; }
    .histItem{
      border:1px solid var(--line);
      background:rgba(255,255,255,.02);
      border-radius:14px;
      padding:12px;
      display:flex;
      justify-content:space-between;
      gap:12px;
    }
    .histMeta{ display:flex; flex-direction:column; gap:4px; }
    .histMeta b{ font-size:13px; }
    .histMeta span{ font-size:12px; color:var(--muted); }
    .histBtns{ display:flex; gap:8px; align-items:flex-start; }
    .miniBtn{ padding:8px 10px; border-radius:10px; font-size:12px; box-shadow:none; }
    .historyTopActions{ display:flex; gap:10px; flex-wrap:wrap; padding-top:10px; }

    /* ===== Chat ===== */
    .chatWrap{ display:flex; flex-direction:column; gap:10px; }
    .chatBox{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      border-radius:14px;
      padding:12px;
      height:360px;
      overflow:auto;
    }
    .msg{ display:flex; margin:10px 0; }
    .msg .bubble{
      max-width:85%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
      white-space:pre-wrap;
      word-wrap:break-word;
      line-height:1.35;
      font-size:14px;
    }
    .msg.user{ justify-content:flex-end; }
    .msg.user .bubble{ background:rgba(124,58,237,.18); }
    .msg.ai{ justify-content:flex-start; }
    .msg.ai .bubble{ background:rgba(34,197,94,.10); }
    .chatRow{ display:flex; gap:10px; }
    .chatRow textarea{
      flex:1;
      min-height:46px;
      max-height:140px;
      resize:vertical;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);
      outline:none;
    }
    .chatMeta{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      font-size:12px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div class="btxt">
          <b>IA Operacional 30D</b>
          <span>Gerador de Prompts + Chat IA (JWT + Neon)</span>
        </div>
      </div>

      <div class="row">
        <span class="pill" id="pillText"><strong>Deslogado</strong><span style="opacity:.7">•</span><span>faça login</span></span>
        <button class="btn btnGhost" id="btnLogout" style="display:none">Sair</button>
        <span class="badge" id="authBadge">Auth: —</span>
      </div>
    </div>

    <div class="grid">
      <!-- LOGIN -->
      <section class="card" id="loginArea">
        <div class="cardHead">
          <div>
            <h2 class="cardTitle">Login</h2>
            <p class="cardSub">Acesso por conta (JWT). O código de cadastro é liberado por você.</p>
          </div>
          <span class="badge" id="loginBadge">—</span>
        </div>

        <div class="cardBody">
          <div class="loginBox">
            <div class="loginRow">
              <div>
                <label>E-mail</label>
                <input class="field" id="loginEmail" placeholder="seu@email.com" autocomplete="email"/>
              </div>
              <div>
                <label>Senha</label>
                <input class="field" id="loginPass" placeholder="••••••••" type="password" autocomplete="current-password"/>
              </div>
            </div>

            <div>
              <label>Código de cadastro (signup code)</label>
              <input class="field" id="signupCode" placeholder="código que você definiu no backend"/>
            </div>

            <div class="actions">
              <button class="btn btnPrimary" id="btnLogin">Entrar</button>
              <button class="btn" id="btnSignup">Criar conta</button>
            </div>

            <div class="splitLine"></div>
            <div class="miniHelp">
              Dica: o token fica salvo no seu navegador (localStorage). Se trocar de PC/navegador, precisa logar de novo.
            </div>
          </div>
        </div>
      </section>

      <!-- APP -->
      <section class="card" id="appArea" style="display:none">
        <div class="cardHead">
          <div>
            <h2 class="cardTitle">Gerador de Prompt (STRICT_MODE=1)</h2>
            <p class="cardSub">Preencha os campos. O prompt final é salvo no histórico (Neon).</p>
          </div>
          <span class="badge" id="badgeStatus">Aguardando</span>
        </div>

        <div class="cardBody">
          <div class="formGrid">
            <div>
              <label>Nicho / Tema</label>
              <input class="field" id="nicho" placeholder="Ex: Controle financeiro simples"/>
            </div>
            <div>
              <label>Objetivo</label>
              <input class="field" id="objetivo" placeholder="Ex: Criar planner financeiro vendável"/>
            </div>
            <div>
              <label>Público</label>
              <input class="field" id="publico" placeholder="Ex: Jovens CLT"/>
            </div>
            <div>
              <label>Formato de saída</label>
              <input class="field" id="formato" placeholder="Ex: Estrutura planner + bônus checklist"/>
            </div>
            <div>
              <label>Nível do público</label>
              <input class="field" id="nivel" placeholder="Ex: iniciante"/>
            </div>
            <div>
              <label>Tom</label>
              <input class="field" id="tom" placeholder="Ex: direto"/>
            </div>
          </div>

          <div style="margin-top:12px">
            <label>Restrições</label>
            <textarea class="field" id="restricoes" placeholder="Ex: frases curtas, sem teoria, passos práticos"></textarea>
          </div>

          <div style="margin-top:12px">
            <label>Papel da IA</label>
            <input class="field" id="papelIA" placeholder="Ex: IA ESPECIALISTA PRODUTO DIGITAL"/>
          </div>

          <div class="actions">
            <button class="btn btnPrimary" id="btnGerar">Gerar Prompt</button>
            <button class="btn" id="btnCopiar" disabled>Copiar</button>
            <button class="btn btnGhost" id="btnLimpar">Limpar</button>
          </div>

          <div class="miniHelp" id="statusLine">Status: —</div>

          <div style="margin-top:12px">
            <label>Saída</label>
            <textarea class="output" id="saida">O prompt vai aparecer aqui…</textarea>
          </div>
        </div>
      </section>

      <div>
        <section class="card">
          <div class="cardHead">
            <div>
              <h2 class="cardTitle">Chat IA</h2>
              <p class="cardSub">Converse com a IA dentro da plataforma. Histórico fica salvo no Neon e o limite diário controla custo.</p>
            </div>
            <div class="chatMeta">
              <span class="chip" id="chatUsageChip">Carregando limite…</span>
              <div class="row" style="gap:10px">
                <button class="btn miniBtn btnGhost" id="btnChatLoad">Carregar histórico</button>
                <button class="btn miniBtn btnDanger" id="btnChatClear">Limpar chat</button>
              </div>
            </div>
          </div>

          <div class="chatWrap" style="padding:16px">
            <div class="chatBox" id="chatBox" aria-live="polite"></div>

            <div class="chatRow">
              <textarea id="chatInput" placeholder="Digite sua mensagem…"></textarea>
              <button class="btn" id="btnChatSend">Enviar</button>
            </div>

            <div class="miniHelp" id="chatStatusLine">Status: pronto.</div>
          </div>
        </section>

        <section class="card" style="margin-top:16px">
          <div class="cardHead">
            <div>
              <h2 class="cardTitle">Histórico</h2>
              <p class="cardSub">Prompts gerados e salvos no Neon. Você pode abrir, copiar ou excluir. O histórico é do seu dispositivo.</p>
            </div>
            <span class="badge" id="historyCount">0</span>
          </div>

          <div class="historyTopActions" style="padding:16px 16px 0">
            <button class="btn miniBtn btnGhost" id="btnRefreshHistory">Atualizar</button>
            <button class="btn miniBtn btnDanger" id="btnClearHistory">Limpar histórico</button>
          </div>

          <div class="historyList" id="historyList" style="padding:16px"></div>
        </section>
      </div>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const API_BASE = "https://prompt-api-7999.onrender.com";
    const TOKEN_KEY = "ia30d_jwt_v1";

    // ===== Helpers =====
    const $ = (id) => document.getElementById(id);

    const loginArea = $("loginArea");
    const appArea = $("appArea");
    const pillText = $("pillText");
    const btnLogout = $("btnLogout");
    const authBadge = $("authBadge");
    const loginBadge = $("loginBadge");

    const btnLogin = $("btnLogin");
    const btnSignup = $("btnSignup");
    const loginEmail = $("loginEmail");
    const loginPass = $("loginPass");
    const signupCode = $("signupCode");

    const btnGerar = $("btnGerar");
    const btnCopiar = $("btnCopiar");
    const btnLimpar = $("btnLimpar");
    const saida = $("saida");
    const badge = $("badgeStatus");
    const statusLine = $("statusLine");

    const historyList = $("historyList");
    const historyCount = $("historyCount");
    const btnRefreshHistory = $("btnRefreshHistory");
    const btnClearHistory = $("btnClearHistory");

    function setStatus(type, text){
      statusLine.textContent = text;
      badge.className = "badge" + (type === "ok" ? " ok" : type === "err" ? " err" : type === "loading" ? " loading" : "");
      badge.textContent =
        type === "loading" ? "Gerando…" :
        type === "ok" ? "Gerado" :
        type === "err" ? "Erro" : "Aguardando";
    }

    function setAuthBadge(type, text){
      authBadge.className = "badge" + (type === "ok" ? " ok" : type === "err" ? " err" : type === "loading" ? " loading" : "");
      authBadge.textContent = text;
    }

    function setLoginBadge(type, text){
      loginBadge.className = "badge" + (type === "ok" ? " ok" : type === "err" ? " err" : type === "loading" ? " loading" : "");
      loginBadge.textContent = text;
    }

    function escapeHtml(s){
      return String(s || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function nowLabelISO(iso){
      try{
        const d = new Date(iso);
        return d.toLocaleString("pt-BR", { dateStyle:"short", timeStyle:"short" });
      }catch{
        return "";
      }
    }

    function getToken(){ return (localStorage.getItem(TOKEN_KEY) || "").trim(); }
    function setToken(t){ localStorage.setItem(TOKEN_KEY, t); }
    function clearToken(){ localStorage.removeItem(TOKEN_KEY); }

    function authHeaders(){
      const t = getToken();
      return {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + t
      };
    }

    async function copyText(text){
      const t = (text || "").trim();
      if (!t) return;
      await navigator.clipboard.writeText(t);
    }

    function getPayload(){
      return {
        nicho: $("nicho").value.trim(),
        objetivo: $("objetivo").value.trim(),
        publico: $("publico").value.trim(),
        formato: $("formato").value.trim(),
        nivel: $("nivel").value.trim(),
        restricoes: $("restricoes").value.trim(),
        papelIA: $("papelIA").value.trim(),
        tom: $("tom").value.trim(),
      };
    }

    function validate(p){
      if (!p.nicho || !p.objetivo || !p.publico || !p.formato || !p.nivel || !p.restricoes || !p.papelIA) {
        return "Preencha: Nicho, Objetivo, Público, Formato, Nível, Restrições e Papel da IA.";
      }
      return null;
    }

    function fillForm(payload){
      $("nicho").value = payload.nicho || "";
      $("objetivo").value = payload.objetivo || "";
      $("publico").value = payload.publico || "";
      $("formato").value = payload.formato || "";
      $("nivel").value = payload.nivel || "";
      $("restricoes").value = payload.restricoes || "";
      $("papelIA").value = payload.papelIA || "";
      $("tom").value = payload.tom || "";
    }

    function showLogged(email){
      loginArea.style.display = "none";
      appArea.style.display = "";
      btnLogout.style.display = "";
      pillText.innerHTML = `<strong>${escapeHtml(email)}</strong><span style="opacity:.7">•</span><span>logado</span>`;
      setAuthBadge("ok", "Auth: OK");
    }

    function showLoggedOut(){
      loginArea.style.display = "";
      appArea.style.display = "none";
      btnLogout.style.display = "none";
      pillText.innerHTML = `<strong>Deslogado</strong><span style="opacity:.7">•</span><span>faça login</span>`;
      setAuthBadge("err", "Auth: OFF");
    }

    // ===== AUTH FLOW =====
    async function checkMe(){
      const t = getToken();
      if (!t) return null;

      const r = await fetch(API_BASE + "/auth/me", {
        method: "GET",
        headers: authHeaders()
      });

      const data = await r.json().catch(() => ({}));
      if (!r.ok) return null;
      return data;
    }

    async function doLogin(email, password){
      const r = await fetch(API_BASE + "/auth/login", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ email, password })
      });
      const data = await r.json().catch(() => ({}));
      if (!r.ok) throw new Error(data?.error || ("HTTP " + r.status));
      return data;
    }

    async function doSignup(email, password, code){
      const r = await fetch(API_BASE + "/auth/signup", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ email, password, code })
      });
      const data = await r.json().catch(() => ({}));
      if (!r.ok) throw new Error(data?.error || ("HTTP " + r.status));
      return data;
    }

    btnLogin.onclick = async () => {
      const email = loginEmail.value.trim().toLowerCase();
      const password = loginPass.value;
      if (!email || !password) return alert("Preencha e-mail e senha.");

      setLoginBadge("loading", "Entrando…");
      btnLogin.disabled = true; btnSignup.disabled = true;
      try{
        const data = await doLogin(email, password);
        setToken(data.token);
        showLogged(data.email);
        setLoginBadge("ok", "Logado ✓");
        await renderHistory();
        await refreshChatUsage();
      }catch(e){
        setLoginBadge("err", "Erro");
        alert("Login falhou: " + (e?.message || "unknown"));
      }finally{
        btnLogin.disabled = false; btnSignup.disabled = false;
      }
    };

    btnSignup.onclick = async () => {
      const email = loginEmail.value.trim().toLowerCase();
      const password = loginPass.value;
      const code = signupCode.value.trim();
      if (!email || !password || !code) return alert("Preencha e-mail, senha e código.");

      setLoginBadge("loading", "Criando…");
      btnLogin.disabled = true; btnSignup.disabled = true;
      try{
        const data = await doSignup(email, password, code);
        setToken(data.token);
        showLogged(data.email);
        setLoginBadge("ok", "Conta criada ✓");
        await renderHistory();
        await refreshChatUsage();
      }catch(e){
        setLoginBadge("err", "Erro");
        alert("Signup falhou: " + (e?.message || "unknown"));
      }finally{
        btnLogin.disabled = false; btnSignup.disabled = false;
      }
    };

    btnLogout.onclick = () => {
      clearToken();
      showLoggedOut();
    };

    // ===== HISTORY (JWT) =====
    async function fetchHistory(limit=50){
      const r = await fetch(API_BASE + "/api/history?limit=" + encodeURIComponent(String(limit)), {
        method: "GET",
        headers: authHeaders()
      });
      const data = await r.json().catch(() => ({}));
      if (!r.ok) throw new Error(data?.error || ("HTTP " + r.status));
      return data.items || [];
    }

    async function deleteHistoryItem(id){
      const r = await fetch(API_BASE + "/api/history/" + encodeURIComponent(id), {
        method: "DELETE",
        headers: authHeaders()
      });
      const data = await r.json().catch(() => ({}));
      if (!r.ok) throw new Error(data?.error || ("HTTP " + r.status));
      return data;
    }

    async function clearHistoryAll(){
      const r = await fetch(API_BASE + "/api/history", {
        method: "DELETE",
        headers: authHeaders()
      });
      const data = await r.json().catch(() => ({}));
      if (!r.ok) throw new Error(data?.error || ("HTTP " + r.status));
      return data;
    }

    function renderHistoryList(items){
      historyList.innerHTML = "";
      historyCount.textContent = String(items.length || 0);

      if (!items.length){
        historyList.innerHTML = `<div class="miniHelp">Nenhum histórico ainda. Gere um prompt para aparecer aqui.</div>`;
        return;
      }

      for (const item of items){
        const id = item.id;
        const created = nowLabelISO(item.created_at);
        const payload = item.payload || {};
        const title =
          (payload.nicho ? String(payload.nicho).slice(0, 42) : "Prompt") +
          (payload.objetivo ? " • " + String(payload.objetivo).slice(0, 42) : "");

        const el = document.createElement("div");
        el.className = "histItem";

        el.innerHTML = `
          <div class="histMeta">
            <b>${escapeHtml(title)}</b>
            <span>${escapeHtml(created)}</span>
          </div>
          <div class="histBtns">
            <button class="btn miniBtn btnGhost" data-act="open" data-id="${escapeHtml(id)}">Abrir</button>
            <button class="btn miniBtn" data-act="copy" data-id="${escapeHtml(id)}">Copiar</button>
            <button class="btn miniBtn btnDanger" data-act="del" data-id="${escapeHtml(id)}">Excluir</button>
          </div>
        `;
        historyList.appendChild(el);
        el._data = item;
      }
    }

    async function renderHistory(){
      try{
        const items = await fetchHistory(80);
        renderHistoryList(items);
      }catch(e){
        historyList.innerHTML = `<div class="miniHelp">Erro ao carregar histórico.</div>`;
      }
    }

    historyList.addEventListener("click", async (ev) => {
      const btn = ev.target.closest("button");
      if (!btn) return;
      const act = btn.dataset.act;
      const id = btn.dataset.id;

      const card = btn.closest(".histItem");
      const item = card?._data;

      if (act === "open"){
        fillForm(item.payload || {});
        saida.value = item.prompt || "(vazio)";
        btnCopiar.disabled = !(item.prompt && item.prompt.length > 5);
        setStatus("ok", "Prompt carregado do histórico.");
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      if (act === "copy"){
        await copyText(item.prompt || "");
        btn.textContent = "Copiado ✓";
        setTimeout(()=> btn.textContent = "Copiar", 800);
      }

      if (act === "del"){
        try{
          btn.disabled = true;
          await deleteHistoryItem(id);
          await renderHistory();
        }catch(err){
          alert("Erro ao excluir: " + (err?.message || "unknown"));
        }finally{
          btn.disabled = false;
        }
      }
    });

    btnRefreshHistory.onclick = () => renderHistory();

    btnClearHistory.onclick = async () => {
      if (!confirm("Tem certeza que deseja apagar TODO o histórico da sua conta?")) return;
      btnClearHistory.disabled = true;
      try{
        await clearHistoryAll();
        await renderHistory();
      }catch(err){
        alert("Erro ao limpar: " + (err?.message || "unknown"));
      }finally{
        btnClearHistory.disabled = false;
      }
    };

    // ===== GENERATE (JWT) =====
    btnGerar.onclick = async () => {
      const payload = getPayload();
      const err = validate(payload);

      btnCopiar.disabled = true;

      if (err){
        saida.value = err;
        setStatus("err", err);
        return;
      }

      btnGerar.disabled = true;
      setStatus("loading", "Gerando…");

      try{
        const r = await fetch(API_BASE + "/api/prompt", {
          method: "POST",
          headers: authHeaders(),
          body: JSON.stringify(payload)
        });

        const data = await r.json().catch(() => ({}));

        if (!r.ok){
          const msg = data?.error || data?.detail || ("HTTP " + r.status);
          saida.value = "Erro ao gerar: " + msg;
          setStatus("err", "Erro ao gerar: " + msg);
          return;
        }

        const prompt = data.prompt || "(sem resposta)";
        saida.value = prompt;
        setStatus("ok", "Gerado e salvo no histórico.");
        btnCopiar.disabled = !(prompt && prompt.length > 5);

        await renderHistory();
      } catch(e){
        saida.value = "Erro de conexão com o servidor.";
        setStatus("err", "Erro de conexão com o servidor.");
      } finally{
        btnGerar.disabled = false;
      }
    };

    btnCopiar.onclick = async () => {
      const text = (saida.value || "").trim();
      if (!text || text.startsWith("Erro")) return;

      await copyText(text);
      const old = btnCopiar.textContent;
      btnCopiar.textContent = "Copiado ✓";
      setTimeout(() => btnCopiar.textContent = old, 900);
    };

    btnLimpar.onclick = () => {
      ["nicho","objetivo","publico","formato","nivel","restricoes","papelIA","tom"].forEach(id => $(id).value = "");
      saida.value = "O prompt vai aparecer aqui…";
      btnCopiar.disabled = true;
      setStatus("idle", "Pronto para gerar.");
    };

    // ===== CHAT (JWT) =====
    const chatBox = $("chatBox");
    const chatInput = $("chatInput");
    const btnChatSend = $("btnChatSend");
    const btnChatLoad = $("btnChatLoad");
    const btnChatClear = $("btnChatClear");
    const chatStatusLine = $("chatStatusLine");
    const chatUsageChip = $("chatUsageChip");

    function chatStatus(text){
      chatStatusLine.textContent = "Status: " + text;
    }

    function chatScrollBottom(){
      chatBox.scrollTop = chatBox.scrollHeight + 9999;
    }

    function chatAdd(role, content){
      const wrap = document.createElement("div");
      wrap.className = "msg " + (role === "user" ? "user" : "ai");
      const b = document.createElement("div");
      b.className = "bubble";
      b.textContent = content || "";
      wrap.appendChild(b);
      chatBox.appendChild(wrap);
      chatScrollBottom();
    }

    function chatClearUI(){
      chatBox.innerHTML = "";
    }

    async function fetchChatUsage(){
      const r = await fetch(API_BASE + "/api/chat/usage", { method:"GET", headers: authHeaders() });
      const data = await r.json().catch(()=> ({}));
      if (!r.ok) throw new Error(data?.error || ("HTTP " + r.status));
      return data;
    }

    async function refreshChatUsage(){
      try{
        const u = await fetchChatUsage();
        chatUsageChip.textContent = `Limite diário: ${u.count}/${u.limit} • Restante: ${u.remaining}`;
      }catch{
        chatUsageChip.textContent = "Limite diário: indisponível";
      }
    }

    async function loadChatHistory(limit=50){
      const r = await fetch(API_BASE + "/api/chat/history?limit=" + encodeURIComponent(String(limit)), {
        method: "GET",
        headers: authHeaders()
      });
      const data = await r.json().catch(()=> ({}));
      if (!r.ok) throw new Error(data?.error || ("HTTP " + r.status));

      const items = Array.isArray(data.items) ? data.items : [];
      items.sort((a,b)=> new Date(a.created_at) - new Date(b.created_at));

      chatClearUI();
      for (const it of items){
        if (it.role === "user") chatAdd("user", it.content);
        else if (it.role === "assistant") chatAdd("assistant", it.content);
      }
      chatStatus(items.length ? "histórico carregado." : "sem histórico.");
      chatScrollBottom();
    }

    async function clearChatHistory(){
      const r = await fetch(API_BASE + "/api/chat/history", {
        method: "DELETE",
        headers: authHeaders()
      });
      const data = await r.json().catch(()=> ({}));
      if (!r.ok) throw new Error(data?.error || ("HTTP " + r.status));
      return data;
    }

    async function sendChat(){
      const text = (chatInput.value || "").trim();
      if (!text) return;

      btnChatSend.disabled = true;
      chatInput.disabled = true;

      chatAdd("user", text);
      chatInput.value = "";
      chatStatus("enviando…");

      try{
        const r = await fetch(API_BASE + "/api/chat", {
          method: "POST",
          headers: authHeaders(),
          body: JSON.stringify({ message: text })
        });

        const data = await r.json().catch(()=> ({}));
        if (!r.ok){
          const err = data?.error || ("HTTP " + r.status);
          if (err === "chat_limit_reached") {
            chatAdd("assistant", "Você atingiu o limite diário de mensagens. Volte amanhã.");
          } else {
            chatAdd("assistant", "Erro: " + err);
          }
          chatStatus("erro.");
          await refreshChatUsage();
          return;
        }

        const reply = data.reply || "";
        chatAdd("assistant", reply || "(sem resposta)");
        chatStatus("respondido.");
        await refreshChatUsage();
      } catch(e){
        chatAdd("assistant", "Erro de conexão com o servidor.");
        chatStatus("erro de conexão.");
      } finally{
        btnChatSend.disabled = false;
        chatInput.disabled = false;
        chatInput.focus();
      }
    }

    btnChatSend.onclick = () => sendChat();
    chatInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        sendChat();
      }
    });

    btnChatLoad.onclick = async () => {
      btnChatLoad.disabled = true;
      try{
        chatStatus("carregando histórico…");
        await loadChatHistory(80);
        await refreshChatUsage();
      }catch(err){
        chatStatus("erro ao carregar.");
        alert("Erro ao carregar chat: " + (err?.message || "unknown"));
      }finally{
        btnChatLoad.disabled = false;
      }
    };

    btnChatClear.onclick = async () => {
      if (!confirm("Apagar TODO o histórico do chat da sua conta?")) return;
      btnChatClear.disabled = true;
      try{
        await clearChatHistory();
        chatClearUI();
        chatStatus("apagado.");
        await refreshChatUsage();
      }catch(err){
        alert("Erro ao apagar chat: " + (err?.message || "unknown"));
      }finally{
        btnChatClear.disabled = false;
      }
    };

    // init
    (async function init(){
      setStatus("idle", "Pronto para gerar.");
      const me = await checkMe();
      if (me?.email){
        showLogged(me.email);
        await renderHistory();
        await refreshChatUsage();
      } else {
        showLoggedOut();
      }
    })();
  </script>
</body>
</html>