<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Gerador — IA Operacional 30D</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#050816;
      --bg1:#0b1220;
      --muted:#9aa4b2;
      --text:#eef2ff;
      --line:rgba(255,255,255,.10);
      --shadow: 0 18px 55px rgba(0,0,0,.40);
      --radius: 18px;
      --accent: #7c3aed;
      --accent2:#22c55e;
      --danger:#ef4444;
      --warn:#f59e0b;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 10% -10%, rgba(124,58,237,.35), transparent 60%),
        radial-gradient(900px 600px at 95% 10%, rgba(34,197,94,.18), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
    }
    .wrap{ max-width:1200px; margin:0 auto; padding:22px 16px 40px; }
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; margin-bottom:16px;
    }
    .brand{ display:flex; align-items:center; gap:12px; min-width:0; }
    .logo{
      width:42px; height:42px; border-radius:14px;
      background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(34,197,94,.75));
      display:grid; place-items:center;
      box-shadow: 0 10px 35px rgba(124,58,237,.25);
      flex:0 0 auto;
      font-weight:800;
    }
    .brand h1{ margin:0; font-size:16px; line-height:1.2; }
    .brand p{ margin:4px 0 0; color:var(--muted); font-size:12px; }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .dot{ width:8px; height:8px; border-radius:50%; background:var(--accent2); }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
      margin-top:12px;
    }
    @media (min-width: 1100px){
      .grid{ grid-template-columns: 1.05fr 1fr .72fr; gap:16px; }
    }

    .card{
      background: rgba(14,23,48,.72);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
      min-height: 100px;
    }
    .cardHead{
      padding:16px 16px 0;
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .cardTitle{ margin:0; font-size:14px; letter-spacing:.2px; }
    .cardSub{ margin:6px 0 0; font-size:12px; color:var(--muted); }
    .cardBody{ padding:16px; }

    .form{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 650px){
      .form.two{ grid-template-columns: 1fr 1fr; }
      .span2{ grid-column: 1 / -1; }
    }

    label{ display:block; font-size:12px; color:var(--muted); margin:0 0 6px; }
    .field{
      background: rgba(5,8,22,.60);
      border: 1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:12px 12px;
      color:var(--text);
      outline:none;
      width:100%;
      transition:.15s ease;
    }
    .field:focus{
      border-color: rgba(124,58,237,.65);
      box-shadow: 0 0 0 4px rgba(124,58,237,.15);
    }
    textarea.field{ min-height: 92px; resize: vertical; }

    .rowActions{ display:flex; flex-wrap:wrap; gap:10px; margin-top: 6px; }
    .btn{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:11px 14px;
      border-radius:14px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
      transition:.15s ease;
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn:active{ transform: translateY(0px); }
    .btnPrimary{
      background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(124,58,237,.65));
      border-color: rgba(124,58,237,.55);
      box-shadow: 0 12px 30px rgba(124,58,237,.20);
    }
    .btnSecondary{
      background: rgba(34,197,94,.10);
      border-color: rgba(34,197,94,.30);
    }
    .btnDanger{
      background: rgba(239,68,68,.10);
      border-color: rgba(239,68,68,.30);
    }
    .btnGhost{ background: transparent; }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none !important; }

    .hint{
      margin-top: 10px;
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }
    .hint b{ color:var(--text); }

    .outputTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:16px 16px 0;
    }
    .status{ display:flex; align-items:center; gap:8px; font-size:12px; color:var(--muted); }
    .badge{
      display:inline-flex; align-items:center;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    .badge.err{ border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.10); color: #fecaca; }
    .badge.ok{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.10); color: #bbf7d0; }
    .badge.loading{ border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.10); color: #fde68a; }

    .outputBox{
      margin:14px 16px 16px;
      background: rgba(5,8,22,.70);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding:12px;
    }
    .output{
      width:100%;
      min-height: 360px;
      border:none;
      outline:none;
      background: transparent;
      color: var(--text);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12.5px;
      line-height:1.55;
      resize: vertical;
    }

    .historyTopActions{ display:flex; gap:10px; flex-wrap:wrap; padding:12px 16px 0; }
    .historyList{
      padding:12px 16px 16px;
      display:flex; flex-direction:column; gap:10px;
      max-height: 560px;
      overflow:auto;
    }
    @media (max-width: 1099px){ .historyList{ max-height: 360px; } }

    .item{
      background: rgba(5,8,22,.55);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding:12px;
    }
    .itemTitle{ font-size:12.5px; font-weight:700; margin:0 0 6px; line-height:1.25; }
    .itemMeta{ font-size:11px; color:var(--muted); margin:0 0 10px; }
    .itemBtns{ display:flex; gap:8px; flex-wrap:wrap; }
    .miniBtn{ padding:8px 10px; border-radius:12px; font-size:12px; }

    .footer{
      margin-top:18px;
      text-align:center;
      font-size:12px;
      color:var(--muted);
      opacity:.9;
    }
    .link{
      color:#c4b5fd;
      text-decoration:none;
      border-bottom:1px dashed rgba(196,181,253,.55);
    }

    /* Login */
    .loginWrap{
      max-width:520px;
      margin: 26px auto 0;
    }
    .splitRow{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .hidden{ display:none !important; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">IA</div>
        <div style="min-width:0">
          <h1>Gerador de Prompts — IA Operacional 30D</h1>
          <p>Área exclusiva. Faça login para usar o gerador e salvar seu histórico.</p>
        </div>
      </div>

      <div class="splitRow">
        <div class="pill" id="pillAuth">
          <span class="dot"></span>
          <span id="pillText">Deslogado</span>
        </div>
        <button class="btn btnGhost hidden" id="btnLogout">Sair</button>
      </div>
    </div>

    <!-- LOGIN -->
    <div class="loginWrap" id="loginArea">
      <section class="card">
        <div class="cardHead">
          <div>
            <h2 class="cardTitle">Login</h2>
            <p class="cardSub">Entre com o e-mail e senha que você criou após comprar.</p>
          </div>
          <span class="badge" id="authBadge">Aguardando</span>
        </div>

        <div class="cardBody">
          <div class="form">
            <div>
              <label for="loginEmail">Email</label>
              <input id="loginEmail" class="field" placeholder="seuemail@..." />
            </div>

            <div>
              <label for="loginPass">Senha</label>
              <input id="loginPass" class="field" type="password" placeholder="••••••••" />
            </div>

            <div class="rowActions">
              <button class="btn btnPrimary" id="btnLogin">Entrar</button>
            </div>

            <div class="hint">
              Primeiro acesso? Use “Criar conta” com o <b>código de ativação</b> que você recebeu.
            </div>

            <hr style="border:none;border-top:1px solid var(--line); margin:14px 0;">

            <h2 class="cardTitle" style="margin:0 0 10px;">Criar conta (1ª vez)</h2>

            <div>
              <label for="signupCode">Código de ativação</label>
              <input id="signupCode" class="field" placeholder="Ex: IA30D-ALUNO-2026" />
            </div>

            <div class="rowActions">
              <button class="btn btnSecondary" id="btnSignup">Criar conta</button>
            </div>

            <div class="hint">
              Se você não quer liberar signup na página pública, você pode remover esse bloco e criar usuários manualmente no banco.
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- APP -->
    <div id="appArea" class="hidden">
      <div class="grid">
        <!-- INPUTS -->
        <section class="card">
          <div class="cardHead">
            <div>
              <h2 class="cardTitle">Inputs do Sistema (pilares)</h2>
              <p class="cardSub">Quanto melhor o input, melhor o prompt. Preencha direto ao ponto.</p>
            </div>
            <span class="badge">v2</span>
          </div>

          <div class="cardBody">
            <div class="form two">
              <div class="span2">
                <label for="nicho">Nicho</label>
                <input id="nicho" class="field" placeholder="Ex: Vídeos TikTok com IA / eBooks com IA / Receitas fitness" />
              </div>

              <div class="span2">
                <label for="objetivo">Objetivo operacional</label>
                <input id="objetivo" class="field" placeholder="Ex: criar 30 roteiros curtos + plano de postagem para 7 dias" />
              </div>

              <div>
                <label for="publico">Público</label>
                <input id="publico" class="field" placeholder="Ex: iniciantes" />
              </div>

              <div>
                <label for="nivel">Nível do usuário</label>
                <select id="nivel" class="field">
                  <option value="">Selecione…</option>
                  <option value="iniciante">Iniciante</option>
                  <option value="intermediário">Intermediário</option>
                  <option value="avançado">Avançado</option>
                </select>
              </div>

              <div class="span2">
                <label for="formato">Formato de saída</label>
                <input id="formato" class="field" placeholder="Ex: tabela com Hook / Script / CTA / Duração (20–40s)" />
              </div>

              <div class="span2">
                <label for="papelIA">Papel da IA (especialista)</label>
                <input id="papelIA" class="field" placeholder="Ex: Estrategista de conteúdo TikTok focado em conversão para low ticket" />
              </div>

              <div class="span2">
                <label for="restricoes">Restrições (obrigatórias)</label>
                <textarea id="restricoes" class="field" placeholder="Ex: sem prometer dinheiro; linguagem simples; passo a passo; baixo orçamento; sem termos técnicos."></textarea>
              </div>

              <div class="span2">
                <label for="tom">Tom (opcional)</label>
                <input id="tom" class="field" placeholder="Ex: direto / amigável / técnico (se vazio: direto e prático)" />
              </div>
            </div>

            <div class="rowActions">
              <button class="btn btnPrimary" id="btnGerar">Gerar prompt</button>
              <button class="btn btnSecondary" id="btnCopiar" disabled>Copiar</button>
              <button class="btn btnGhost" id="btnLimpar">Limpar</button>
            </div>

            <div class="hint">
              Dica: se quiser prompt <b>mais forte</b>, aumente “Restrições” e seja específico no “Formato”.
            </div>
          </div>
        </section>

        <!-- OUTPUT -->
        <section class="card">
          <div class="outputTop">
            <div>
              <h2 class="cardTitle" style="margin:0;">Prompt gerado</h2>
              <div class="status" id="statusLine">Pronto para gerar.</div>
            </div>
            <span class="badge" id="badgeStatus">Aguardando</span>
          </div>

          <div class="outputBox">
            <textarea id="saida" class="output" readonly>O prompt vai aparecer aqui…</textarea>
          </div>

          <div class="cardBody" style="padding-top:0;">
            <div class="hint" style="margin-top:0;">
              Copie e cole no ChatGPT. Se quiser iterar, altere apenas 1 pilar por vez (ex: “Formato”).
            </div>
            <div class="footer">
              Suporte: <a class="link" href="mailto:suporte@metodoia30d.com">suporte@metodoia30d.com</a>
            </div>
          </div>
        </section>

        <!-- HISTÓRICO -->
        <section class="card">
          <div class="cardHead">
            <div>
              <h2 class="cardTitle">Histórico</h2>
              <p class="cardSub">Salvo na nuvem (Neon), sincroniza em qualquer dispositivo.</p>
            </div>
            <span class="badge" id="historyCount">0</span>
          </div>

          <div class="historyTopActions">
            <button class="btn miniBtn btnGhost" id="btnRefreshHistory">Atualizar</button>
            <button class="btn miniBtn btnDanger" id="btnClearHistory">Limpar histórico</button>
          </div>

          <div class="historyList" id="historyList"></div>
        </section>
      </div>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const API_BASE = "https://prompt-api-7999.onrender.com"; // backend
    const TOKEN_KEY = "ia30d_jwt_v1";

    // ===== Helpers =====
    const $ = (id) => document.getElementById(id);

    const loginArea = $("loginArea");
    const appArea = $("appArea");
    const pillText = $("pillText");
    const btnLogout = $("btnLogout");
    const authBadge = $("authBadge");

    const btnLogin = $("btnLogin");
    const btnSignup = $("btnSignup");
    const loginEmail = $("loginEmail");
    const loginPass = $("loginPass");
    const signupCode = $("signupCode");

    const btnGerar = $("btnGerar");
    const btnCopiar = $("btnCopiar");
    const btnLimpar = $("btnLimpar");
    const saida = $("saida");
    const badge = $("badgeStatus");
    const statusLine = $("statusLine");

    const historyList = $("historyList");
    const historyCount = $("historyCount");
    const btnRefreshHistory = $("btnRefreshHistory");
    const btnClearHistory = $("btnClearHistory");

    function setStatus(type, text){
      statusLine.textContent = text;
      badge.className = "badge" + (type === "ok" ? " ok" : type === "err" ? " err" : type === "loading" ? " loading" : "");
      badge.textContent =
        type === "loading" ? "Gerando…" :
        type === "ok" ? "Gerado" :
        type === "err" ? "Erro" : "Aguardando";
    }

    function setAuthBadge(type, text){
      authBadge.className = "badge" + (type === "ok" ? " ok" : type === "err" ? " err" : type === "loading" ? " loading" : "");
      authBadge.textContent = text;
    }

    function escapeHtml(s){
      return String(s || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function nowLabelISO(iso){
      try{
        const d = new Date(iso);
        return d.toLocaleString("pt-BR", { dateStyle:"short", timeStyle:"short" });
      }catch{
        return "";
      }
    }

    function getToken(){ return (localStorage.getItem(TOKEN_KEY) || "").trim(); }
    function setToken(t){ localStorage.setItem(TOKEN_KEY, t); }
    function clearToken(){ localStorage.removeItem(TOKEN_KEY); }

    function authHeaders(){
      const t = getToken();
      return {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + t
      };
    }

    async function copyText(text){
      const t = (text || "").trim();
      if (!t) return;
      await navigator.clipboard.writeText(t);
    }

    function getPayload(){
      return {
        nicho: $("nicho").value.trim(),
        objetivo: $("objetivo").value.trim(),
        publico: $("publico").value.trim(),
        formato: $("formato").value.trim(),
        nivel: $("nivel").value.trim(),
        restricoes: $("restricoes").value.trim(),
        papelIA: $("papelIA").value.trim(),
        tom: $("tom").value.trim(),
      };
    }

    function validate(p){
      if (!p.nicho || !p.objetivo || !p.publico || !p.formato || !p.nivel || !p.restricoes || !p.papelIA) {
        return "Preencha: Nicho, Objetivo, Público, Formato, Nível, Restrições e Papel da IA.";
      }
      return null;
    }

    function fillForm(payload){
      $("nicho").value = payload.nicho || "";
      $("objetivo").value = payload.objetivo || "";
      $("publico").value = payload.publico || "";
      $("formato").value = payload.formato || "";
      $("nivel").value = payload.nivel || "";
      $("restricoes").value = payload.restricoes || "";
      $("papelIA").value = payload.papelIA || "";
      $("tom").value = payload.tom || "";
    }

    // ===== AUTH FLOW =====
    async function checkMe(){
      const t = getToken();
      if (!t) return null;

      const r = await fetch(API_BASE + "/auth/me", {
        method: "GET",
        headers: { "Authorization": "Bearer " + t }
      });

      if (!r.ok) return null;
      return r.json();
    }

    function showLogged(email){
      loginArea.classList.add("hidden");
      appArea.classList.remove("hidden");
      btnLogout.classList.remove("hidden");
      pillText.textContent = "Logado: " + email;
      setAuthBadge("ok", "Logado");
    }

    function showLoggedOut(){
      loginArea.classList.remove("hidden");
      appArea.classList.add("hidden");
      btnLogout.classList.add("hidden");
      pillText.textContent = "Deslogado";
      setAuthBadge("idle", "Aguardando");
    }

    btnLogout.onclick = () => {
      clearToken();
      showLoggedOut();
    };

    btnLogin.onclick = async () => {
      setAuthBadge("loading", "Entrando…");
      btnLogin.disabled = true;
      try{
        const r = await fetch(API_BASE + "/auth/login", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({
            email: loginEmail.value.trim(),
            password: loginPass.value
          })
        });
        const data = await r.json().catch(()=> ({}));
        if (!r.ok) {
          setAuthBadge("err", data?.error || ("HTTP " + r.status));
          return;
        }
        setToken(data.token);
        const me = await checkMe();
        if (!me?.email) {
          setAuthBadge("err", "Falha ao validar token");
          clearToken();
          return;
        }
        showLogged(me.email);
        await renderHistory();
      } finally {
        btnLogin.disabled = false;
      }
    };

    btnSignup.onclick = async () => {
      setAuthBadge("loading", "Criando…");
      btnSignup.disabled = true;
      try{
        const r = await fetch(API_BASE + "/auth/signup", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({
            email: loginEmail.value.trim(),
            password: loginPass.value,
            signup_code: signupCode.value.trim()
          })
        });
        const data = await r.json().catch(()=> ({}));
        if (!r.ok) {
          setAuthBadge("err", data?.error || ("HTTP " + r.status));
          return;
        }
        setToken(data.token);
        const me = await checkMe();
        if (!me?.email) {
          setAuthBadge("err", "Falha ao validar token");
          clearToken();
          return;
        }
        showLogged(me.email);
        await renderHistory();
      } finally {
        btnSignup.disabled = false;
      }
    };

    // ===== HISTORY (JWT) =====
    async function fetchHistory(limit = 30){
      const r = await fetch(API_BASE + "/api/history?limit=" + encodeURIComponent(String(limit)), {
        method: "GET",
        headers: { "Authorization":"Bearer " + getToken() }
      });
      const data = await r.json().catch(()=> ({}));
      if (!r.ok) throw new Error(data?.error || data?.detail || ("HTTP " + r.status));
      return data.items || [];
    }

    async function deleteHistoryItem(id){
      const r = await fetch(API_BASE + "/api/history/" + encodeURIComponent(id), {
        method: "DELETE",
        headers: { "Authorization":"Bearer " + getToken() }
      });
      const data = await r.json().catch(()=> ({}));
      if (!r.ok) throw new Error(data?.error || data?.detail || ("HTTP " + r.status));
      return data;
    }

    async function clearHistoryAll(){
      const items = await fetchHistory(100);
      if (!items.length) return;

      const ids = items.map(x => x.id);
      const BATCH = 5;

      for (let i = 0; i < ids.length; i += BATCH){
        const slice = ids.slice(i, i + BATCH);
        await Promise.allSettled(slice.map(id => deleteHistoryItem(id)));
      }
    }

    async function renderHistory(){
      historyList.innerHTML = `
        <div style="padding:10px 2px; color: var(--muted); font-size:12px; line-height:1.4;">
          Carregando histórico…
        </div>
      `;

      const items = await fetchHistory(30);
      historyCount.textContent = String(items.length);

      if (!items.length){
        historyList.innerHTML = `
          <div style="padding:10px 2px; color: var(--muted); font-size:12px; line-height:1.4;">
            Nenhum prompt salvo ainda.
          </div>
        `;
        return;
      }

      historyList.innerHTML = items.map(item => `
        <div class="item">
          <div class="itemTitle">${escapeHtml(item.title || "Prompt")}</div>
          <div class="itemMeta">${escapeHtml(nowLabelISO(item.created_at))}</div>
          <div class="itemBtns">
            <button class="btn miniBtn btnGhost" data-act="open" data-id="${escapeHtml(item.id)}">Abrir</button>
            <button class="btn miniBtn btnSecondary" data-act="copy" data-id="${escapeHtml(item.id)}">Copiar</button>
            <button class="btn miniBtn btnDanger" data-act="del" data-id="${escapeHtml(item.id)}">Excluir</button>
          </div>
        </div>
      `).join("");
    }

    historyList.addEventListener("click", async (e) => {
      const btn = e.target.closest("button[data-act]");
      if (!btn) return;

      const act = btn.getAttribute("data-act");
      const id = btn.getAttribute("data-id");

      const items = await fetchHistory(30);
      const item = items.find(x => x.id === id);
      if (!item) return;

      if (act === "open"){
        fillForm(item.payload || {});
        saida.value = item.prompt || "(vazio)";
        btnCopiar.disabled = !(item.prompt && item.prompt.length > 5);
        setStatus("ok", "Prompt carregado do histórico.");
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      if (act === "copy"){
        await copyText(item.prompt || "");
        btn.textContent = "Copiado ✓";
        setTimeout(()=> btn.textContent = "Copiar", 800);
      }

      if (act === "del"){
        try{
          btn.disabled = true;
          await deleteHistoryItem(id);
          await renderHistory();
        }catch(err){
          alert("Erro ao excluir: " + (err?.message || "unknown"));
        }finally{
          btn.disabled = false;
        }
      }
    });

    btnRefreshHistory.onclick = () => renderHistory();

    btnClearHistory.onclick = async () => {
      if (!confirm("Tem certeza que deseja apagar TODO o histórico da sua conta?")) return;
      btnClearHistory.disabled = true;
      try{
        await clearHistoryAll();
        await renderHistory();
      }catch(err){
        alert("Erro ao limpar: " + (err?.message || "unknown"));
      }finally{
        btnClearHistory.disabled = false;
      }
    };

    // ===== GENERATE (JWT) =====
    btnGerar.onclick = async () => {
      const payload = getPayload();
      const err = validate(payload);

      btnCopiar.disabled = true;

      if (err){
        saida.value = err;
        setStatus("err", err);
        return;
      }

      btnGerar.disabled = true;
      setStatus("loading", "Gerando prompt…");
      saida.value = "Gerando…";

      try{
        const r = await fetch(API_BASE + "/api/prompt", {
          method: "POST",
          headers: authHeaders(),
          body: JSON.stringify(payload)
        });

        const data = await r.json().catch(() => ({}));

        if (!r.ok){
          const msg = data?.error || data?.detail || ("HTTP " + r.status);
          saida.value = "Erro ao gerar: " + msg;
          setStatus("err", "Erro ao gerar: " + msg);
          return;
        }

        const prompt = data.prompt || "(sem resposta)";
        saida.value = prompt;
        setStatus("ok", "Gerado e salvo no histórico.");
        btnCopiar.disabled = !(prompt && prompt.length > 5);

        await renderHistory();
      } catch(e){
        saida.value = "Erro de conexão com o servidor.";
        setStatus("err", "Erro de conexão com o servidor.");
      } finally{
        btnGerar.disabled = false;
      }
    };

    btnCopiar.onclick = async () => {
      const text = (saida.value || "").trim();
      if (!text || text.startsWith("Erro")) return;

      await copyText(text);
      const old = btnCopiar.textContent;
      btnCopiar.textContent = "Copiado ✓";
      setTimeout(() => btnCopiar.textContent = old, 900);
    };

    btnLimpar.onclick = () => {
      ["nicho","objetivo","publico","formato","nivel","restricoes","papelIA","tom"].forEach(id => $(id).value = "");
      saida.value = "O prompt vai aparecer aqui…";
      btnCopiar.disabled = true;
      setStatus("idle", "Pronto para gerar.");
    };

    // init
    (async function init(){
      setStatus("idle", "Pronto para gerar.");
      const me = await checkMe();
      if (me?.email){
        showLogged(me.email);
        await renderHistory();
      } else {
        showLoggedOut();
      }
    })();
  </script>
</body>
</html>
