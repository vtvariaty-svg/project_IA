<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin — IA Operacional 30D</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#050816; --panel:rgba(14,23,48,.72); --text:#eef2ff; --muted:#9aa4b2;
      --line:rgba(255,255,255,.10); --r:18px; --shadow: 0 18px 55px rgba(0,0,0,.40);
      --ok:#22c55e; --bad:#ef4444; --acc:#7c3aed;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--text);
      background:
        radial-gradient(1200px 700px at 10% -10%, rgba(124,58,237,.35), transparent 60%),
        radial-gradient(900px 600px at 95% 10%, rgba(34,197,94,.18), transparent 55%),
        linear-gradient(180deg, var(--bg), #0b1220);
      min-height:100vh;
    }
    .wrap{max-width:1050px;margin:0 auto;padding:22px 16px 40px}
    .top{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:42px;height:42px;border-radius:14px;display:grid;place-items:center;font-weight:800;
      background:linear-gradient(135deg, rgba(124,58,237,.95), rgba(34,197,94,.75))}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);backdrop-filter:blur(10px)}
    .card h2{margin:0;font-size:14px}
    .sub{margin:6px 0 0;color:var(--muted);font-size:12px}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px}
    @media(min-width:980px){.grid{grid-template-columns: 1fr 1fr}}
    .pad{padding:16px}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input{width:100%;padding:12px;border-radius:14px;border:1px solid var(--line);background:rgba(5,8,22,.6);color:var(--text);outline:none}
    input:focus{border-color:rgba(124,58,237,.65);box-shadow:0 0 0 4px rgba(124,58,237,.15)}
    .row{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:650px){.row.two{grid-template-columns:1fr 1fr}}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    button{
      border:1px solid var(--line); background:rgba(255,255,255,.06); color:var(--text);
      padding:11px 14px; border-radius:14px; cursor:pointer; font-weight:800; font-size:13px;
    }
    .primary{background:linear-gradient(135deg, rgba(124,58,237,.95), rgba(124,58,237,.65));border-color:rgba(124,58,237,.55)}
    .ok{background:rgba(34,197,94,.10);border-color:rgba(34,197,94,.30)}
    .bad{background:rgba(239,68,68,.10);border-color:rgba(239,68,68,.30)}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.06);color:var(--muted);font-size:12px}
    .dot{width:8px;height:8px;border-radius:50%;background:var(--bad)}
    .dot.on{background:var(--ok)}
    .log{
      margin-top:12px; padding:12px; border-radius:14px; border:1px solid var(--line);
      background:rgba(5,8,22,.6); color:var(--muted); font-size:12px; line-height:1.5;
      white-space:pre-wrap; word-break:break-word; min-height:90px;
    }
    table{width:100%;border-collapse:collapse;margin-top:12px;font-size:12px}
    th,td{border-bottom:1px solid rgba(255,255,255,.08);padding:10px;text-align:left;vertical-align:top}
    th{color:var(--muted);font-weight:700}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .mini{padding:8px 10px;border-radius:12px;font-weight:800;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo">IA</div>
        <div>
          <div style="font-weight:900">Admin — IA Operacional 30D</div>
          <div class="sub">Cadastrar usuários / resetar senha / listar / excluir</div>
        </div>
      </div>
      <div class="pill"><span class="dot" id="dot"></span><span id="st">Desconectado</span></div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="pad">
          <h2>Conexão</h2>
          <p class="sub">Use sua ADMIN_KEY (Render ENV). Não salva no servidor.</p>

          <div class="row">
            <div>
              <label>API Base (backend)</label>
              <input id="api" value="https://prompt-api-7999.onrender.com"/>
            </div>
            <div>
              <label>ADMIN_KEY</label>
              <input id="key" type="password" placeholder="cole aqui"/>
            </div>
          </div>

          <div class="btns">
            <button class="primary" id="btnTest">Testar</button>
            <button id="btnSave">Salvar nesta sessão</button>
            <button class="bad" id="btnClear">Limpar</button>
          </div>

          <div class="log" id="log">Log…</div>
        </div>
      </div>

      <div class="card">
        <div class="pad">
          <h2>Criar usuário</h2>
          <p class="sub">Cria email + senha (hash no banco).</p>

          <div class="row two">
            <div>
              <label>Email</label>
              <input id="newEmail" placeholder="aluno@..."/>
            </div>
            <div>
              <label>Senha</label>
              <input id="newPass" placeholder="mínimo 6" type="text"/>
            </div>
          </div>

          <div class="btns">
            <button class="ok" id="btnCreate">Criar</button>
          </div>

          <hr style="border:none;border-top:1px solid rgba(255,255,255,.10);margin:16px 0">

          <h2>Resetar senha</h2>
          <p class="sub">Reseta para uma senha nova.</p>

          <div class="row two">
            <div>
              <label>Email</label>
              <input id="resetEmail" placeholder="aluno@..."/>
            </div>
            <div>
              <label>Nova senha</label>
              <input id="resetPass" placeholder="mínimo 6" type="text"/>
            </div>
          </div>

          <div class="btns">
            <button class="ok" id="btnReset">Resetar</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <div class="pad">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
          <div>
            <h2>Usuários cadastrados</h2>
            <p class="sub">Lista os últimos cadastrados.</p>
          </div>
          <div class="btns" style="margin:0">
            <button id="btnRefresh" class="primary">Atualizar lista</button>
          </div>
        </div>

        <div id="tableWrap"></div>
      </div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);
  const logEl = $("log");
  const dot = $("dot");
  const st = $("st");

  function log(msg){
    logEl.textContent = (logEl.textContent === "Log…" ? "" : logEl.textContent + "\n") + msg;
    logEl.scrollTop = logEl.scrollHeight;
  }

  function setConnected(ok){
    dot.classList.toggle("on", !!ok);
    st.textContent = ok ? "Conectado" : "Desconectado";
  }

  function apiBase(){ return $("api").value.trim().replace(/\/+$/,""); }
  function adminKey(){ return ($("key").value.trim() || sessionStorage.getItem("ADMIN_KEY") || "").trim(); }

  function adminHeaders(){
    return {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + adminKey()
    };
  }

  async function probeHealth(){
    // tenta /health, se falhar tenta /
    const base = apiBase();

    try{
      log("Testando /health...");
      const r = await fetch(base + "/health", { method:"GET" });
      const data = await r.json().catch(()=> ({}));
      log("health => " + JSON.stringify(data));
      if (data && data.ok === true) return true;
      // se respondeu JSON mas ok != true, ainda assim seguimos para o teste admin
      log("Aviso: /health não retornou ok=true (seguindo teste admin).");
      return true;
    }catch(e){
      log("Aviso: /health indisponível (seguindo teste em /).");
    }

    try{
      log("Testando / ...");
      const r = await fetch(base + "/", { method:"GET" });
      const data = await r.json().catch(()=> ({}));
      log("/ => " + JSON.stringify(data));
      return true;
    }catch(e){
      throw new Error("Backend não responde em /health nem em /");
    }
  }

  async function test(){
    await probeHealth();

    log("Testando /admin/users (autorização)...");
    const r2 = await fetch(apiBase() + "/admin/users?limit=1", { headers: adminHeaders() });
    const d2 = await r2.json().catch(()=> ({}));
    if (!r2.ok) throw new Error("admin/users => " + (d2.error || r2.status));
    log("admin/users OK");
    setConnected(true);
  }

  async function refreshUsers(){
    const r = await fetch(apiBase() + "/admin/users?limit=80", { headers: adminHeaders() });
    const data = await r.json().catch(()=> ({}));
    if (!r.ok) throw new Error(data.error || ("HTTP " + r.status));

    const users = data.users || [];
    if (!users.length){
      $("tableWrap").innerHTML = "<div style='color:#9aa4b2;font-size:12px;padding:10px 0'>Nenhum usuário.</div>";
      return;
    }

    $("tableWrap").innerHTML = `
      <table>
        <thead>
          <tr><th>Email</th><th>Criado em</th><th>Ações</th></tr>
        </thead>
        <tbody>
          ${users.map(u => `
            <tr>
              <td>${escapeHtml(u.email)}</td>
              <td>${escapeHtml(new Date(u.created_at).toLocaleString("pt-BR"))}</td>
              <td>
                <div class="actions">
                  <button class="mini ok" data-act="copy" data-email="${escapeHtml(u.email)}">Copiar email</button>
                  <button class="mini bad" data-act="del" data-email="${escapeHtml(u.email)}">Excluir</button>
                </div>
              </td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;
  }

  function escapeHtml(s){
    return String(s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  $("btnSave").onclick = () => {
    const k = $("key").value.trim();
    if (!k) return alert("Cole a ADMIN_KEY");
    sessionStorage.setItem("ADMIN_KEY", k);
    log("ADMIN_KEY salva nesta sessão.");
  };

  $("btnClear").onclick = () => {
    $("key").value = "";
    sessionStorage.removeItem("ADMIN_KEY");
    setConnected(false);
    logEl.textContent = "Log…";
  };

  $("btnTest").onclick = async () => {
    try{
      setConnected(false);
      await test();
      await refreshUsers();
    }catch(e){
      setConnected(false);
      log("ERRO: " + (e.message || e));
      alert("Falhou: " + (e.message || e));
    }
  };

  $("btnRefresh").onclick = async () => {
    try{
      await refreshUsers();
      log("Lista atualizada.");
    }catch(e){
      log("ERRO: " + (e.message || e));
      alert("Falhou: " + (e.message || e));
    }
  };

  $("btnCreate").onclick = async () => {
    try{
      const email = $("newEmail").value.trim().toLowerCase();
      const password = $("newPass").value;
      if (!email || !password) return alert("Preencha email e senha");
      if (password.length < 6) return alert("Senha mínima: 6");

      const r = await fetch(apiBase() + "/admin/users", {
        method:"POST",
        headers: adminHeaders(),
        body: JSON.stringify({ email, password })
      });

      const data = await r.json().catch(()=> ({}));
      if (!r.ok) throw new Error(data.error || ("HTTP " + r.status));
      log("Usuário criado: " + email);
      $("newEmail").value = "";
      $("newPass").value = "";
      await refreshUsers();
      alert("Criado: " + email);
    }catch(e){
      log("ERRO: " + (e.message || e));
      alert("Falhou: " + (e.message || e));
    }
  };

  $("btnReset").onclick = async () => {
    try{
      const email = $("resetEmail").value.trim().toLowerCase();
      const new_password = $("resetPass").value;
      if (!email || !new_password) return alert("Preencha email e nova senha");
      if (new_password.length < 6) return alert("Senha mínima: 6");

      const r = await fetch(apiBase() + "/admin/users/reset", {
        method:"POST",
        headers: adminHeaders(),
        body: JSON.stringify({ email, new_password })
      });

      const data = await r.json().catch(()=> ({}));
      if (!r.ok) throw new Error(data.error || ("HTTP " + r.status));
      log("Senha resetada: " + email);
      $("resetEmail").value = "";
      $("resetPass").value = "";
      alert("Senha resetada para: " + email);
    }catch(e){
      log("ERRO: " + (e.message || e));
      alert("Falhou: " + (e.message || e));
    }
  };

  $("tableWrap").addEventListener("click", async (e) => {
    const btn = e.target.closest("button[data-act]");
    if (!btn) return;
    const act = btn.getAttribute("data-act");
    const email = btn.getAttribute("data-email");

    if (act === "copy"){
      await navigator.clipboard.writeText(email);
      btn.textContent = "Copiado ✓";
      setTimeout(()=> btn.textContent = "Copiar email", 800);
    }

    if (act === "del"){
      if (!confirm("Excluir usuário e histórico? " + email)) return;
      try{
        const r = await fetch(apiBase() + "/admin/users/" + encodeURIComponent(email), {
          method:"DELETE",
          headers: adminHeaders()
        });
        const data = await r.json().catch(()=> ({}));
        if (!r.ok) throw new Error(data.error || ("HTTP " + r.status));
        log("Excluído: " + email);
        await refreshUsers();
      }catch(err){
        log("ERRO: " + (err.message || err));
        alert("Falhou: " + (err.message || err));
      }
    }
  });

  if (sessionStorage.getItem("ADMIN_KEY")) {
    log("ADMIN_KEY encontrada na sessão. Clique em 'Testar' para validar.");
  }
</script>
</body>
</html>